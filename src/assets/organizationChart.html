<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.0.1"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.3/jspdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!doctype html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">

<head>

    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>HR Zone | Organization Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Human Resource Management Software" name="description" />
    <meta content="Human Resource Management Software" name="author" />
    <!-- App favicon -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/fontawesome.min.css" integrity="sha384-jLKHWM3JRmfMU0A5x5AkjWkw/EYfGUAGagvnfryNV3F9VqM98XiIH7VBGVoxVSc7" crossorigin="anonymous">

    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.4.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.8/css/line.css">
    <!-- jsvectormap css -->
    <link href="styles\css\jsvectormap.min.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Outlined"
      rel="stylesheet">
    <!--Swiper slider css-->
    <link href="styles\css\swiper-bundle.min.css" rel="stylesheet" type="text/css" />
    <link href="styles\css\sweetalert2.min.css" rel="stylesheet" type="text/css" />
    <!-- Layout config Js -->
    <script src="styles\js\layout.js"></script>
    <!-- Bootstrap Css -->
    <link href="styles\css\bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="styles\css\icons.min.css" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="styles\css\app.min.css" rel="stylesheet" type="text/css" />
    <!-- custom Css-->
    <link href="styles\css\custom.min.css" rel="stylesheet" type="text/css" />
    <link href="styles\css\dropzone.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="styles\css\filepond.min.css" type="text/css" />
    <link rel="stylesheet" href="styles\css\filepond-plugin-image-preview.min.css">
</head>

<body  style="overflow-x: hidden;">
    <!-- Begin page -->
    <div id="layout-wrapper">
        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
    

            <div class="container-fluid">

                <!--Chart-->
                <div class="row ma-10">
                    <div class="col-lg-12">
                        <div  class="card shadow-lg" ><div class="row align-items-center gy-3" id="btndiv">
                            <div class="pt-2" >
                                <button type="button" class="btn btn-success font-type fs-15 margin-up-10" onclick="downloadPdf()" style="float:right"><i class="ri-printer-line" title="Print"></i></button>
                                <button type="button" class="btn btn-success font-type fs-15 margin-up-10 " onclick="fit()" style="margin-right: 2px;float: right;"><i class="ri-fullscreen-fill" title="Fit to screen"></i></button>
                                <button type="button" class="btn btn-info font-type fs-15 margin-up-10" onclick="closing()" ><i class="ri-arrow-go-back-line me-1" title="Back"></i>Back</button>
                            </div>
                            </div></div>
                        <div class="card shadow-lg" id="fulldiv">
                            <div class="card-header border border-dashed pa-6-8">
                                <!-- <div class="row align-items-center gy-3" style="float:right">
                                    <div class="pt-2">
                                        <button type="button" class="btn btn-success font-type fs-15 margin-up-10" onclick="downloadPdf()"><i class="ri-printer-line" title="Print"></i></button>
                                        <button type="button" class="btn btn-info font-type fs-15 margin-up-10" onclick="close()"><i class="ri-arrow-go-back-line me-1" title="Back"></i>Back</button>
                                    </div>
                                    </div> -->
                                <div class="row align-items-center gy-3">
                                    <div class="col-sm">
                                        <div class="align-items-center d-flex">
                                            <div class="col-sm-auto">
                                                <span>
                                                    <img src="" id="logimg" alt="" width="120px" Height="60px">
                                                </span>
                                            </div>
                                            <h4 class="card-title mb-0 flex-grow-1 text-center fs-13 font-type fw-semibold text-uppercase text-info" style="visibility: hidden;">D</h4>
                                            <h2 class="card-title mb-0 flex-grow-1 text-center fs-13 font-type fw-semibold text-uppercase text-info" >Organization Chart</h2>
                                        </div>
                                    </div>
                                    <div class="col-sm-auto">
                                        <div class="d-flex gap-3 flex-wrap">

                                            <div>
                                                <h4 class="card-title mb-0 flex-grow-1 fs-13 font-type fw-semibold" id="nodiv">No of Employees:<span class="ms-1 fw-medium" id="ecount"></span></h4>
                                            </div>
                                            <div>
                                            <h4 class="card-title mb-0 flex-grow-1 fs-13 font-type fw-semibold" id="ecdiv">Date:<span class="ms-1 fw-medium" id="dd"></span></h4>
                                            </div>
                                            <div>
                                                <h4 class="card-title mb-0 flex-grow-1 fs-13 font-type fw-semibold" id="enmdiv">Employee:<span class="ms-1 fw-medium" id="enamespan"></span></h4>
                                                </div>
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body pt-0 text-center">
                                <br/>
                                <div class="chart-container" id="chartdiv"></div>
                                <style>
                                #chartdiv {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
      
}
</style>
<script>
 const queryString = window.location.search;
   const urlParams = new URLSearchParams(queryString);
//    const emp = urlParams.get('empcode')
//    const comp = urlParams.get('company')
//    const ecount = urlParams.get('ecount')
  var  date="";
   const emp = localStorage.getItem('chrt_empcode')
   const comp =  localStorage.getItem('chrt_company')
   const ecount =  localStorage.getItem('chrt_ecount')
   const viewtp =  localStorage.getItem('chrt_viewtp')
   const chart_api =  localStorage.getItem('chart_api')
   const emprole =  localStorage.getItem('emprole')
  //alert(viewtp)
   if(viewtp==1)
   {
    document.getElementById('btndiv').style.display='none';
    document.getElementById('ecdiv').style.color='white';
    document.getElementById('dd').style.color='white';
   }
   else{
   
    document.getElementById('btndiv').style.display='inline';
    const dd = new Date(localStorage.getItem('chrt_dd'))
    if(dd!='Invalid Date')
   {
     date = '' + dd.getDate() + '-' + (1 + dd.getMonth()) + '-' + dd.getFullYear().toString();
    document.getElementById('dd').innerHTML=date;
    document.getElementById('dd').style.color='black';
    document.getElementById('dd').style.display='inline';
    document.getElementById('ecdiv').style.color='black';
    document.getElementById('ecdiv').style.display='inline';
   }
   else{
    document.getElementById('btndiv').style.display='none';
    document.getElementById('ecdiv').style.color='white';
    document.getElementById('dd').style.color='white';
   }
   }
   let logotag=document.getElementById('logimg');
  
   //alert(dd)
 
   if(emp!='-1')
   {
    const ename =  localStorage.getItem('chrt_ename');
    document.getElementById('nodiv').style.color='white';
    document.getElementById('enamespan').innerHTML=ename;
   }
   else{
  
    document.getElementById('ecount').innerHTML=ecount;
   
   document.getElementById('nodiv').style.color='black';
   document.getElementById('enmdiv').style.color='white';
 // document.getElementById('ecdiv').style.color='black';
  //document.getElementById('dd').style.color='black';
   }
  
   

   
  //alert(comp)
   if(comp=='MJ')
    {
       // logotag.src="styles\img\MTC logo.png";
        logotag.src = "styles/img/MTC logo.png";
    }
    if(comp=='MH')
    {
        logotag.src="styles/img/MTC logo.png";
    }
    if(comp=='WM')
    {
        logotag.src="styles/img/WOM Logo - 2024.png";
    }
    if(comp=='WV')
    {
        logotag.src="styles/img/WVC-LOGO-2024.png";
    }
    if(comp=='WS')
    {
        logotag.src="styles/img/WOM Logo - 2024.png";
    }
   // alert(emp)
    //const comp = 'MJ';
    //alert(comp)
  var chart = null;
 // const apiUrl='http://localhost:90/api/Login/GetCSVdata/-1/MJ';
 //http://localhost:90/api/Login/GetCSVdata/'+emp+'/'+comp+'
  //'https://raw.githubusercontent.com/bumbeishvili/sample-data/main/org.csv'
  // This is the data used - https://github.com/bumbeishvili/sample-data/blob/main/data-oracle.csv
  //alert('in chart')
  d3.csv(
     chart_api+'/Login/GetCSVdata/'+emp+'/'+comp+''
  ).then((data) => {
  try {
    chart = new d3.OrgChart()
      .nodeHeight(d => 75)
      .nodeWidth(d => 142)
      .childrenMargin(d => 45)
      .compactMarginBetween(d => 25)
      .compactMarginPair(d => 10)
      .neighbourMargin((a, b) => 10)
      .initialZoom(0.6)
      .nodeContent(function (d) {
        return `
          <div style='width:${d.width}px;height:${d.height}px;padding:1px;'>
            <div style="font-family: 'HK Grotesk', sans-serif; font-weight: bold; font-size: 15px; background-color: #f3f6f9; width:${d.width - 2}px; height:${d.height}px; border-radius: 5px; border: 1px solid black;">
              <div style="display:flex; justify-content:flex-end;"></div>
              <div style="font-size: 13px; color: #17a2b8; padding: 6px 10px; font-family: 'HK Grotesk', sans-serif;">${d.data.name}</div>
              <div style="color: black; padding: 5px 10px; font-size: 12px; font-family: 'HK Grotesk', sans-serif;">${d.data.positionName}</div>
            </div>
          </div>
        `;
      })
      .container('.chart-container')
      .data(data)
      .render();

    // Function to apply link styles
    const applyLinkStyles = () => {
      d3.selectAll('path') // Select all <path> elements directly
        .style('stroke', '#17a2b8') // Set link color to red
        .style('stroke-width', '2'); // Optional: adjust stroke width
    };

    // Initial application of styles
    applyLinkStyles();

    // Mutation observer to monitor changes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(() => {
        applyLinkStyles(); // Reapply styles whenever a mutation occurs
      });
    });

    // Start observing the chart container for changes
    observer.observe(document.querySelector('.chart-container'), {
      childList: true,
      subtree: true,
    });

    // Initial expansion
    chart.expandAll(); // Start with all nodes expanded
  } catch (error) {
    if (emprole.includes('HR')) {
        console.log('Error value:', error);
        console.log('Error type:', typeof error);

        // Convert to string if not already a string
              
               // Check if the error message matches the expected format
        const regex = /^Error:\s*missing:\s*(.+)$/; // Regex to capture the employee code
        const match = regex.exec(error);

        if (match) {
            const empCode = match[1].trim(); // Get the employee code from the match
            alert('Failed to render the OrgChart: Employee ' + empCode + ' does not belong to this company');
           
        } else {
            alert('Error format is incorrect. Please check the error message format.');
        }
    } else {
        alert('Failed to render the OrgChart');
    }
}
  
  });
  
</script>
<script>
    function  fit()
    {
        chart.fit();
    }
  function downloadPdf() { 
 //fit();
  // document.getElementById('btnprint').style.display='none';
    const element = document.getElementById("fulldiv");
    const options = {
        margin: [0, 0, 0, 0],
                filename: 'Orgchart_'+date+'.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1 }, // Increase the scale for better quality
                jsPDF: { unit: 'cm', format: 'a3', orientation: 'landscape' } // Set orientation to landscape
            };

            // Generate PDF
            html2pdf().from(element).set(options).save();
    }
   function closing()
    {
       history.back();
       
    }
</script>

                            </div>
                        </div>
                    </div>
                    <!--end col-->
                </div>
                <!--End Chart-->


                <!-- Fullscreen Modals -->
              <!-- Full screen modal content -->
              <div class="modal fade exampleModalFullscreen" tabindex="-1" aria-labelledby="exampleModalFullscreenLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                        <div class="modal-header bg-orange" style="padding-bottom: 10px;">
                            <div class="flex-grow-1 text-truncate"></div>
                            <div class="flex-shrink-0">
                                <button type="button" class="btn btn-sm btn-info font-type fs-12 add-button me-2"><i class="ri-download-2-line me-1"></i>Download PDF</button>
                            </div>
                            <button type="button" class="btn-close ms-3" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row margin-up-10">
                                <div class="col-lg-12 col-md-12 col-sm-6">
                                    <div class="card">
                                        <div class="card-header border border-dashed pa-6-8">
                                            <div class="row align-items-center gy-3">
                                                <div class="col-sm">
                                                    <div class="align-items-center d-flex">
                                                        <div class="col-sm-auto">
                                                            <span class="avatar-title bg-transparent">
                                                                <img src="styles\img\logo3.png" alt="" width="120px" Height="80px">
                                                            </span>
                                                        </div>
                                                        <h4 class="card-title mb-0 flex-grow-1 text-center fs-13 font-type fw-semibold text-uppercase">Organization Chart</h4>
                                                    </div>
                                                </div>
                                                <div class="col-sm-auto">
                                                    <div class="d-flex gap-1 flex-wrap">
                                                        <h4 class="card-title mb-0 flex-grow-1 fs-13 font-type fw-semibold">09/08/2024</h4>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body pt-0">
                                            CHART HERE
                                        </div>
                                    </div>
                                </div>
                                <!--end col-->
                            </div>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
               </div><!-- /.modal -->

        
                </div>
                <!-- container-fluid -->
       
            <!-- End Page-content -->
  
        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->

    <!-- JAVASCRIPT -->
    <script src="styles\js\bootstrap.bundle.min.js"></script>
    <script src="styles\js\simplebar.min.js"></script>
    <script src="styles\js\waves.min.js"></script>
    <script src="styles\js\feather.min.js"></script>
    <script src="styles\js\lord-icon-2.1.0.js"></script>
    <script src="styles\js\plugins.js"></script>
    <script src="styles\js\dropzone-min.js"></script>
 
    <!-- list.js min js -->
    <script src="styles\js\list.min.js"></script>

    <!--list pagination js-->
    <script src="styles\js\list.pagination.min.js"></script>

    <!-- ecommerce-order init js -->
    <script src="styles\js\ecommerce-order.init.js"></script>

    <!-- Sweet Alerts js -->
    <script src="styles\js\sweetalert2.min.js"></script>
    <script src="styles\js\flatpickr.js"></script>
    <!-- App js -->
    <script src="styles\js\app.js"></script>
</body>

</html>